<VirtualHost *:80>
    ServerName danklco.com
    ServerAlias www.danklco.com
    ServerAlias www.danklco.local

    DocumentRoot /var/www/html
    ErrorLog /var/log/apache2/danklco-com.err
    CustomLog /var/log/apache2/danklco-com.log combined

    RewriteEngine on
    RewriteCond %{SERVER_NAME} =danklco.com [OR]
    RewriteCond %{SERVER_NAME} =www.danklco.com
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [L,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName danklco.com
    ServerAlias www.danklco.com
    ServerAlias www.danklco.local

    DocumentRoot /var/www/html
    <Directory /var/www/html>
        Require all granted
    </Directory>
    ErrorLog /var/log/apache2/danklco-com.err
    CustomLog /var/log/apache2/danklco-com.log combined

    # SSL 
    Include /etc/cloudflare/ssl.conf

    RewriteEngine on
    RewriteRule ^/content/personal-sites/danklco-com(.*)$ https://www.danklco.com$1 [L,R=301]
    RewriteRule "^/feed\.xml$"  "/feed.rss.xml" [PT]
    RewriteRule "^/sitemap\.xml$"  "/sitemap.sitemap.xml" [PT]
    RewriteRule "^/?$" "/index.html" [PT]

    # Redirect the old post URLs to the new post URLs
    RewriteRule "^\/posts\/(\d{4})\/(\d{2})\/\d{2}\/(.+)\/$" "/posts/$1/$2/$3.html" [L,R=301]
    RewriteRule "^\/posts\/(\d{4})\/(\d{2})\/\d{2}\/(.+)$" "/posts/$1/$2/$3.html" [L,R=301]
    RewriteRule "^\/tag\/(.+)\/?$" "/search.html?q=$1" [L,R=301]
    RewriteRule "^\/engagement\/(.+)\/?$" "/projects/$1.html" [L,R=301]
    RewriteRule "^\/contact\/?$" "/contact.html" [L,R=301]
    RewriteRule "^\/curriculum-vitae\/?$" "/curriculum-vitae.html" [L,R=301]
    RewriteRule "^\/my-work\/?$" "/my-work.html" [L,R=301]
    RewriteRule "^\/projects\/?$" "/projects.html" [L,R=301]
    RewriteRule "^\/search\/?$" "/search.html" [L,R=301]
    RewriteRule "^\/rockstar2019.+" "/posts/2019/03/aem-rockstar-2019.html" [L,R=301]

    # Deny certain urls
    RewriteRule "^.+\..*\.json" - [F,L]

    RewriteCond %{REQUEST_METHOD} ^(delete|post|trace|track) [NC]
    RewriteCond %{REQUEST_URI} !^.+allowpost\.html$
    RewriteRule .* - [F,L]

    # Configure mod_expire
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    ExpiresByType text/html "access plus 5 minutes"
    ExpiresByType application/json "access plus 5 minutes"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"

    # Configure mod_cache
    CacheEnable disk /
    CacheIgnoreNoLastMod On
    CacheDefaultExpire 600

    # Caching Log Files
    LogFormat "%{cache-status}e ..."
    CustomLog "/var/log/apache2/cache-cached-requests.log" common env=cache-hit
    CustomLog "/var/log/apache2/cache-uncached-requests.log" common env=cache-miss
    CustomLog "/var/log/apache2/cache-revalidated-requests.log" common env=cache-revalidate
    CustomLog "/var/log/apache2/cache-invalidated-requests.log" common env=cache-invalidate

    # Configure Proxy
    ProxyPass /.well-known !
    ProxyPass /ERROR !
    ProxyPass /static/clientlibs/danklco-com/ http://cms:8080/static/clientlibs/danklco-com/ connectiontimeout=10 timeout=60 retry=0
    ProxyPassReverse /static/clientlibs/danklco-com/ http://cms:8080/static/clientlibs/danklco-com/
    ProxyPass / http://cms:8080/content/personal-sites/danklco-com/ connectiontimeout=10 timeout=60 retry=0
    ProxyPassReverse /content/personal-sites/danklco-com/ http://cms:8080/content/personal-sites/danklco-com/

    # Configure Error Documents if Down
    ErrorDocument 502 /ERROR/503.html
    ErrorDocument 503 /ERROR/503.html
    ErrorDocument 504 /ERROR/503.html
    Alias /ERROR /var/www/html
    AllowEncodedSlashes on

    # Compress text files
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json

    # Security Protection
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    Header set Feature-Policy "sync-xhr 'self'"
    Header set Content-Security-Policy "default-src https: data: 'unsafe-inline'; frame-ancestors https:"
    Header set X-Powered-By "Technology and Caffine"

    # Add encoding for WOFF
    AddDefaultCharset UTF-8
    AddCharset UTF-8 .woff
</VirtualHost>